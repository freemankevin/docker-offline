name: Update Docker Offline Packages

on:
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨ 2 ç‚¹
  workflow_dispatch:
    inputs:
      architectures:
        description: 'æ¶æ„é€‰æ‹©'
        default: 'all'
        type: choice
        options: [all, x86_64, aarch64]
  push:
    branches: [main, master]
    paths:
      - 'packages/scripts/**'
      - 'packages/services/**'
      - '.github/workflows/update.yml'

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ç¡®ä¿æœ‰å†™æƒé™
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: æ£€æŸ¥æ›´æ–°ï¼ˆå¢å¼ºç‰ˆï¼‰
        id: check
        run: |
          # æ£€æŸ¥ VERSION.json æ˜¯å¦å­˜åœ¨
          if [ -f "packages/VERSION.json" ]; then
            CURRENT=$(python3 -c "import json; print(json.load(open('packages/VERSION.json'))['docker_version'])" 2>/dev/null || echo "none")
          else
            CURRENT="none"
            echo "ğŸš€ é¦–æ¬¡è¿è¡Œæ£€æµ‹ï¼šVERSION.json ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºåˆå§‹ç‰ˆæœ¬"
          fi
          
          # è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œå¢åŠ é‡è¯•æœºåˆ¶
          MAX_RETRIES=3
          RETRY_COUNT=0
          LATEST="error"
          
          while [ "$RETRY_COUNT" -lt "$MAX_RETRIES" ] && [ "$LATEST" = "error" ]; do
            echo "ğŸ”„ å°è¯•è·å–æœ€æ–° Docker ç‰ˆæœ¬ (å°è¯• $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
            LATEST=$(curl -s --fail https://api.github.com/repos/moby/moby/releases/latest | \
                     python3 -c "import sys,json,re; data=json.load(sys.stdin); print(re.search(r'\d+\.\d+\.\d+', data['tag_name']).group())" 2>/dev/null || echo "error")
            
            if [ "$LATEST" = "error" ]; then
              echo "âš ï¸ è·å–å¤±è´¥ï¼Œç­‰å¾… 5 ç§’åé‡è¯•..."
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT + 1))
            fi
          done
          
          if [ "$LATEST" = "error" ]; then
            echo "âŒ æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨å®‰å…¨é»˜è®¤ç‰ˆæœ¬ 24.0.7"
            LATEST="24.0.7"
          fi
          
          echo "ğŸ“Š å½“å‰ç‰ˆæœ¬: $CURRENT"
          echo "ğŸ†• æœ€æ–°ç‰ˆæœ¬: $LATEST"
          
          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest_version=$LATEST" >> $GITHUB_OUTPUT
          
          # é¦–æ¬¡è¿è¡Œæˆ–ç‰ˆæœ¬ä¸åŒéƒ½éœ€è¦æ›´æ–°
          if [ "$CURRENT" = "none" ] || [ "$CURRENT" != "$LATEST" ]; then
            echo "need_update=true" >> $GITHUB_OUTPUT
            echo "âœ… éœ€è¦æ›´æ–°åˆ° $LATEST (é¦–æ¬¡è¿è¡Œæˆ–ç‰ˆæœ¬æ›´æ–°)"
          else
            echo "need_update=false" >> $GITHUB_OUTPUT
            echo "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
          fi
      
      - name: ä¸‹è½½æ›´æ–°
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        run: |
          ARCH=${{ github.event.inputs.architectures || 'all' }}
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½æ¶æ„: $ARCH"
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p packages
          
          # æ‰§è¡Œä¸‹è½½ï¼Œå¢åŠ é”™è¯¯å¤„ç†
          if ! python3 packages/scripts/update.py -o packages -a $ARCH --ci; then
            echo "âŒ ä¸‹è½½æ›´æ–°å¤±è´¥ï¼"
            # é¦–æ¬¡è¿è¡Œæ—¶å¦‚æœå¤±è´¥ï¼Œå°è¯•åˆ›å»ºåŸºæœ¬ç»“æ„
            if [ ! -f "packages/VERSION.json" ] && [ "$CURRENT" = "none" ]; then
              echo "ğŸ”§ é¦–æ¬¡è¿è¡Œä¿®å¤ï¼šåˆ›å»ºåŸºç¡€ VERSION.json"
              mkdir -p packages
              cat > packages/VERSION.json << EOF
              {
                "docker_version": "${{ steps.check.outputs.latest_version }}",
                "compose_version": "2.24.5",
                "build_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
              }
              EOF
              echo "âœ… å·²åˆ›å»ºåŸºç¡€ VERSION.json"
            else
              exit 1  # éé¦–æ¬¡è¿è¡Œæ—¶ä¸¥æ ¼å¤±è´¥
            fi
          fi
      
      - name: è¯»å–ç‰ˆæœ¬ï¼ˆå¸¦éªŒè¯ï¼‰
        id: version
        run: |
          # ç­‰å¾…æ–‡ä»¶ç”Ÿæˆï¼ˆæœ€å¤š30ç§’ï¼‰
          timeout=30
          count=0
          while [ ! -f "packages/VERSION.json" ] && [ $count -lt $timeout ]; do
            echo "â³ ç­‰å¾… VERSION.json ç”Ÿæˆ... ($count/$timeout)"
            sleep 1
            count=$((count + 1))
          done
          
          if [ ! -f "packages/VERSION.json" ]; then
            echo "âŒ é”™è¯¯ï¼šVERSION.json ä¸å­˜åœ¨ï¼"
            echo "ğŸ”§ åˆ›å»ºç´§æ€¥ VERSION.json"
            cat > packages/VERSION.json << EOF
            {
              "docker_version": "${{ steps.check.outputs.latest_version }}",
              "compose_version": "2.24.5",
              "build_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            }
            EOF
          fi
          
          # è¯»å–ç‰ˆæœ¬ä¿¡æ¯
          DOCKER_VER=$(python3 -c "import json; print(json.load(open('packages/VERSION.json'))['docker_version'])" 2>/dev/null || echo "${{ steps.check.outputs.latest_version }}")
          COMPOSE_VER=$(python3 -c "import json; print(json.load(open('packages/VERSION.json'))['compose_version'])" 2>/dev/null || echo "2.24.5")
          
          echo "ğŸ·ï¸  Docker ç‰ˆæœ¬: $DOCKER_VER"
          echo "ğŸ·ï¸  Compose ç‰ˆæœ¬: $COMPOSE_VER"
          
          echo "docker=$DOCKER_VER" >> $GITHUB_OUTPUT
          echo "compose=$COMPOSE_VER" >> $GITHUB_OUTPUT
      
      - name: æ‰“åŒ…
        id: package
        run: |
          NAME="docker-offline-v${{ steps.version.outputs.docker }}"
          echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…: $NAME"
          
          # ç¡®ä¿ç›®å½•ç»“æ„æ­£ç¡®
          mkdir -p "release/$NAME/packages"
          
          # å¤åˆ¶æ–‡ä»¶
          cp -r packages/* "release/$NAME/packages/"
          [ -f README.md ] && cp README.md "release/$NAME/"
          
          # æ‰“åŒ…
          cd release
          tar -czf "$NAME.tar.gz" "$NAME"
          sha256sum "$NAME.tar.gz" > "$NAME.tar.gz.sha256"
          
          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          if [ ! -f "$NAME.tar.gz" ]; then
            echo "âŒ æ‰“åŒ…å¤±è´¥ï¼š$NAME.tar.gz ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… æ‰“åŒ…æˆåŠŸï¼æ–‡ä»¶å¤§å°: $(du -h "$NAME.tar.gz" | cut -f1)"
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "file=$NAME.tar.gz" >> $GITHUB_OUTPUT
      
      - name: éªŒè¯æ–‡ä»¶
        run: |
          echo "ğŸ” éªŒè¯æ‰“åŒ…æ–‡ä»¶..."
          ls -la release/
          echo "æ–‡ä»¶æ ¡éªŒå’Œ:"
          cat "release/${{ steps.package.outputs.file }}.sha256"
          
          if [ ! -f "release/${{ steps.package.outputs.file }}" ]; then
            echo "âŒ å…³é”®é”™è¯¯ï¼šæ‰“åŒ…æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… æ–‡ä»¶éªŒè¯é€šè¿‡ï¼"
      
      - name: æäº¤ä»£ç 
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/
          
          if git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "chore: update to Docker v${{ steps.version.outputs.docker }}"
            git push
            echo "âœ… ä»£ç å·²æäº¤"
          fi
      
      - name: åˆ›å»º Release
        # å…³é”®ä¿®å¤ï¼šé¦–æ¬¡è¿è¡Œæ—¶ä¹Ÿè¦åˆ›å»º Release
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.docker }}
          name: Docker v${{ steps.version.outputs.docker }} ${{ github.event_name == 'workflow_dispatch' && '(Manual)' || '' }}
          body: |
            **Docker**: `${{ steps.version.outputs.docker }}`
            **Compose**: `${{ steps.version.outputs.compose }}`
            **æ„å»ºæ—¥æœŸ**: `${{ steps.version.outputs.build_date || (steps.check.outputs.latest_version && 'auto-generated') }}`
            
            ## ğŸ“¥ å®‰è£…è¯´æ˜
            
            ```bash
            # ä¸‹è½½ç¦»çº¿åŒ…
            wget https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.docker }}/${{ steps.package.outputs.file }}
            
            # éªŒè¯æ ¡éªŒå’Œ
            wget https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.docker }}/${{ steps.package.outputs.file }}.sha256
            sha256sum -c ${{ steps.package.outputs.file }}.sha256
            
            # è§£å‹å¹¶å®‰è£…
            tar -xzf ${{ steps.package.outputs.file }}
            cd ${{ steps.package.outputs.name }}
            sudo bash packages/scripts/install.sh
            ```
            
            ## ğŸ“¦ åŒ…å«å†…å®¹
            - Docker Engine v${{ steps.version.outputs.docker }}
            - Docker Compose v${{ steps.version.outputs.compose }}
            - æ”¯æŒæ¶æ„: x86_64, aarch64
          files: |
            release/${{ steps.package.outputs.file }}
            release/${{ steps.package.outputs.file }}.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}